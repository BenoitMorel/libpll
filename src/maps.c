/*
    Copyright (C) 2015 Tomas Flouri

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as
    published by the Free Software Foundation, either version 3 of the
    License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.

    Contact: Tomas Flouri <Tomas.Flouri@h-its.org>,
    Exelixis Lab, Heidelberg Instutute for Theoretical Studies
    Schloss-Wolfsbrunnenweg 35, D-69118 Heidelberg, Germany
*/

#include "pll.h"

unsigned int pll_map_bin[256] =
 {
   0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
   0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
   0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0,
   1, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3,
   0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
   0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
   0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
   0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
   0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
   0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
   0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
   0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
   0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
   0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
   0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
   0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  };

unsigned int pll_map_nt[256] =
 {
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 15,  0,  0,
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 15,
   0,  1, 14,  2, 13,  0,  0,  4, 11,  0,  0, 12,  0,  3, 15, 15,
   0,  0,  5,  6,  8,  8,  7,  9, 15, 10,  0,  0,  0,  0,  0,  0,
   0,  1, 14,  2, 13,  0,  0,  4, 11,  0,  0, 12,  0,  3, 15, 15,
   0,  0,  5,  6,  8,  8,  7,  9, 15, 10,  0,  0,  0,  0,  0,  0,
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
 };

unsigned int pll_map_aa[256] =
 {
           0,       0,       0,       0,       0,       0,       0,       0, 
           0,       0,       0,       0,       0,       0,       0,       0,
           0,       0,       0,       0,       0,       0,       0,       0, 
           0,       0,       0,       0,       0,       0,       0,       0,
           0,       0,       0,       0,       0,       0,       0,       0, 
           0,       0, 0xfffff,       0,       0, 0xfffff,       0,       0,
           0,       0,       0,       0,       0,       0,       0,       0, 
           0,       0,       0,       0,       0,       0,       0, 0xfffff,
           0, 0x00001, 0x0000c, 0x00010, 0x00008, 0x00040, 0x02000, 0x00080, 
     0x00100, 0x00200,       0, 0x00800, 0x00400, 0x01000, 0x00004,       0,
     0x04000, 0x00020, 0x00002, 0x08000, 0x10000,       0, 0x80000, 0x20000, 
     0xfffff, 0x40000, 0x00060,       0,       0,       0,       0,       0,
           0, 0x00001, 0x0000c, 0x00010, 0x00008, 0x00040, 0x02000, 0x00080,
     0x00100, 0x00200,       0, 0x00800, 0x00400, 0x01000, 0x00004,       0,
     0x04000, 0x00020, 0x00002, 0x08000, 0x10000,       0, 0x80000, 0x20000,
     0xfffff, 0x40000, 0x00060,       0,       0,       0,       0,       0,
           0,       0,       0,       0,       0,       0,       0,       0,
           0,       0,       0,       0,       0,       0,       0,       0,
           0,       0,       0,       0,       0,       0,       0,       0, 
           0,       0,       0,       0,       0,       0,       0,       0, 
           0,       0,       0,       0,       0,       0,       0,       0, 
           0,       0,       0,       0,       0,       0,       0,       0, 
           0,       0,       0,       0,       0,       0,       0,       0, 
           0,       0,       0,       0,       0,       0,       0,       0, 
           0,       0,       0,       0,       0,       0,       0,       0, 
           0,       0,       0,       0,       0,       0,       0,       0,
           0,       0,       0,       0,       0,       0,       0,       0,
           0,       0,       0,       0,       0,       0,       0,       0,
           0,       0,       0,       0,       0,       0,       0,       0,
           0,       0,       0,       0,       0,       0,       0,       0,
           0,       0,       0,       0,       0,       0,       0,       0,
           0,       0,       0,       0,       0,       0,       0,       0
 };

int pll_fill_aa_matrix(double * mat, int aa_model)
{

  switch (aa_model)
    {
    case PLL_PROTMODEL_DAYHOFF:
      {
        double pll_daa_dayhoff[190] =
          {
       27.00,   98.00,  120.00,   36.00,   89.00,  198.00,  240.00,   23.00,   65.00,   41.00,
       26.00,   72.00,   18.00,  250.00,  409.00,  371.00,    0.00,   24.00,  208.00,   32.00,
        0.00,   23.00,  246.00,    1.00,    9.00,  240.00,   64.00,   15.00,  464.00,   90.00,
       14.00,  103.00,  154.00,   26.00,  201.00,    8.00,   24.00,  905.00,    0.00,  103.00,
      148.00,  139.00,  535.00,   77.00,   34.00,  318.00,    1.00,   14.00,   42.00,  495.00,
      229.00,   23.00,   95.00,   15.00,    0.00,  134.00, 1153.00,  125.00,   86.00,   24.00,
        0.00,   71.00,    0.00,    0.00,   13.00,   95.00,   66.00,    0.00,    0.00,   18.00,
        0.00,    0.00,   11.00,   28.00,   44.00,    0.00,    0.00,    0.00,    0.00,   19.00,
      161.00,   16.00,    0.00,   96.00,   49.00,  716.00,   28.00,  606.00,   18.00,   73.00,
      153.00,  114.00,    0.00,  153.00,   56.00,   53.00,    0.00,    0.00,   35.00,   81.00,
       43.00,   61.00,   11.00,   83.00,   30.00,    0.00,   51.00,   79.00,   34.00,    0.00,
       22.00,   37.00,   10.00,    0.00,    7.00,   27.00,   17.00,   15.00,   34.00,  234.00,
       30.00,    0.00,    0.00,   54.00,    7.00,   44.00,   26.00,    0.00,   48.00,   94.00,
       35.00,   22.00,   27.00,  127.00,   44.00,  257.00,   46.00,  336.00,  196.00,   12.00,
       24.00,  192.00,    0.00,   37.00,  889.00,   18.00,  527.00,  157.00,   32.00,   17.00,
       33.00,   46.00,   28.00,  175.00,  243.00,    0.00,   33.00,   96.00,  136.00,    0.00,
       13.00,   10.00,   92.00,   17.00,   62.00,  104.00,    0.00,    0.00,  258.00,   11.00,
       46.00,   13.00,   76.00,  698.00,   12.00,  245.00,   78.00,    0.00,    0.00,   48.00,
      550.00,   75.00,   34.00,   30.00,    0.00,   42.00,  157.00,   61.00,    0.00,   28.00
          };
        memcpy(mat, pll_daa_dayhoff, 190*sizeof(double));
      }
      break;
    case PLL_PROTMODEL_LG:
      {
        double pll_daa_lg[190] =
          {
      0.4250930, 0.2768180, 0.3951440, 2.4890840, 0.9698940, 1.0385450, 2.0660400, 0.3588580, 0.1498300, 0.3953370,
      0.5365180, 1.1240350, 0.2537010, 1.1776510, 4.7271820, 2.1395010, 0.1807170, 0.2189590, 2.5478700, 0.7518780,
      0.1239540, 0.5345510, 2.8079080, 0.3639700, 0.3901920, 2.4266010, 0.1269910, 0.3018480, 6.3260670, 0.4841330,
      0.0527220, 0.3325330, 0.8581510, 0.5789870, 0.5936070, 0.3144400, 0.1708870, 5.0761490, 0.5287680, 1.6957520,
      0.5417120, 1.4376450, 4.5092380, 0.1915030, 0.0684270, 2.1450780, 0.3710040, 0.0895250, 0.1617870, 4.0083580,
      2.0006790, 0.0453760, 0.6120250, 0.0836880, 0.0625560, 0.5233860, 5.2438700, 0.8449260, 0.9271140, 0.0106900,
      0.0150760, 0.2829590, 0.0255480, 0.0174160, 0.3944560, 1.2402750, 0.4258600, 0.0298900, 0.1351070, 0.0379670,
      0.0848080, 0.0034990, 0.5692650, 0.6405430, 0.3206270, 0.5940070, 0.0132660, 0.8936800, 1.1052510, 0.0753820,
      2.7844780, 1.1434800, 0.6701280, 1.1655320, 1.9592910, 4.1285910, 0.2679590, 4.8135050, 0.0728540, 0.5824570,
      3.2342940, 1.6725690, 0.0358550, 0.6242940, 1.2238280, 1.0801360, 0.2361990, 0.2573360, 0.2103320, 0.3488470,
      0.4238810, 0.0442650, 0.0696730, 1.8071770, 0.1737350, 0.0188110, 0.4194090, 0.6119730, 0.6045450, 0.0778520,
      0.1200370, 0.2450340, 0.3114840, 0.0087050, 0.0442610, 0.2966360, 0.1395380, 0.0895860, 0.1969610, 1.7399900,
      0.1298360, 0.2684910, 0.0546790, 0.0767010, 0.1088820, 0.3663170, 0.6972640, 0.4424720, 0.6821390, 0.5088510,
      0.9900120, 0.5842620, 0.5970540, 5.3068340, 0.1190130, 4.1450670, 0.1590690, 4.2736070, 1.1127270, 0.0782810,
      0.0641050, 1.0337390, 0.1116600, 0.2325230,10.6491070, 0.1375000, 6.3123580, 2.5926920, 0.2490600, 0.1822870,
      0.3029360, 0.6196320, 0.2996480, 1.7027450, 0.6566040, 0.0239180, 0.3903220, 0.7486830, 1.1368630, 0.0499060,
      0.1319320, 0.1852020, 1.7988530, 0.0998490, 0.3469600, 2.0203660, 0.6961750, 0.4813060, 1.8987180, 0.0944640,
      0.3618190, 0.1650010, 2.4571210, 7.8039020, 0.6546830, 1.3381320, 0.5714680, 0.0951310, 0.0896130, 0.2965010,
      6.4722790, 0.2488620, 0.4005470, 0.0983690, 0.1408250, 0.2458410, 2.1881580, 3.1518150, 0.1895100, 0.2493130
  };
        memcpy(mat, pll_daa_lg, 190*sizeof(double));
      }
      break;
    default:
      return PLL_FAILURE;
    }
  return PLL_SUCCESS;
}

int pll_fill_aa_frequencies(double * freqs, int aa_model)
{
  switch (aa_model)
    {
    case PLL_PROTMODEL_DAYHOFF:
      {
        /*
         * WARNING:
         *    In PhyML/PAML the last frequency is 0.064718 instead of 064717.
         *    This makes the frequencies summing to 1.000001 instead of 1.
         */
        double pll_freqs_dayhoff[20] =
          {
          0.087127, 0.040904, 0.040432, 0.046872, 0.033474, 0.038255, 0.049530, 0.088612, 0.033618, 0.036886,
          0.085357, 0.080482, 0.014753, 0.039772, 0.050680, 0.069577, 0.058542, 0.010494, 0.029916, 0.064717
          };
        memcpy(freqs, pll_freqs_dayhoff, 20*sizeof(double));
      }
      break;
    case PLL_PROTMODEL_LG:
      {
        double pll_freqs_lg[20] =
          {
          0.079066, 0.055941, 0.041977, 0.053052, 0.012937, 0.040767, 0.071586, 0.057337, 0.022355, 0.062157,
          0.099081, 0.064600, 0.022951, 0.042302, 0.044040, 0.061197, 0.053287, 0.012066, 0.034155, 0.069147
          };
        memcpy(freqs, pll_freqs_lg, 20*sizeof(double));
      }
      break;
    default:
      return PLL_FAILURE;
    }
  return PLL_SUCCESS;
}
